
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#5cb85c" />
    <link rel="manifest" href="manifest.json" />
    <link rel="icon" href="icon-192.png" />
    <title>v2xcrypt</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
        }
        label {
            display: block;
            margin: 10px 0 5px;
        }
        input, textarea, select {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            width: 100%;
            padding: 10px;
            background-color: #5cb85c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
        }
        button:hover {
            background-color: #4cae4c;
        }
        textarea[readonly] {
            background-color: #f9f9f9;
        }
        .checkmark {
            position: absolute;
            right: 10px;
            display: none;
            color: #5cb85c;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Text Encrypter/Decrypter</h1>
        <h4>NOTE: If you ever forget the password used for encryption, there is no way to get back your data.</h4>
        <label for="mode">Choose Mode:</label>
        <select id="mode">
            <option value="encrypt">Encrypt</option>
            <option value="decrypt">Decrypt</option>
        </select>

        <label for="password">Password:</label>
        <input type="password" id="password" required>

        <label for="text">Text:</label>
        <textarea id="text" rows="4" required></textarea>

        <label><input type="checkbox" id="includePassword"> Include password in copy/download</label>
        
        <button id="submit">Submit</button>
        
        <h2>Result:</h2>
        <textarea id="result" rows="4" readonly></textarea>
        
        <button id="copyButton">Copy <span class="checkmark">✔</span></button>
        <button id="downloadButton">Download <span class="checkmark">✔</span></button>
    </div>
    <script>
        function arrayBufferToBase64(buffer) {
            const uint8Array = new Uint8Array(buffer);
            let binaryString = '';
            uint8Array.forEach(byte => binaryString += String.fromCharCode(byte));
            return window.btoa(binaryString);
        }

        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const length = binaryString.length;
            const buffer = new ArrayBuffer(length);
            const uint8Array = new Uint8Array(buffer);
            for (let i = 0; i < length; i++) {
                uint8Array[i] = binaryString.charCodeAt(i);
            }
            return buffer;
        }

        async function generateKey(password, salt) {
            const enc = new TextEncoder();
            const keyMaterial = await window.crypto.subtle.importKey("raw", enc.encode(password), { name: "PBKDF2" }, false, ["deriveBits", "deriveKey"]);
            return window.crypto.subtle.deriveKey({
                name: "PBKDF2",
                salt: salt,
                iterations: 100000,
                hash: "SHA-256"
            }, keyMaterial, { name: "AES-GCM", length: 256 }, true, ["encrypt", "decrypt"]);
        }

        async function encrypt(text, password) {
            const iv = window.crypto.getRandomValues(new Uint8Array(12));
            const salt = window.crypto.getRandomValues(new Uint8Array(16));
            const key = await generateKey(password, salt);
            const enc = new TextEncoder();
            const encrypted = await window.crypto.subtle.encrypt({ name: "AES-GCM", iv: iv }, key, enc.encode(text));
            const combinedArray = new Uint8Array(iv.length + salt.length + encrypted.byteLength);
            combinedArray.set(iv);
            combinedArray.set(salt, iv.length);
            combinedArray.set(new Uint8Array(encrypted), iv.length + salt.length);
            return arrayBufferToBase64(combinedArray.buffer);
        }

        async function decrypt(base64Data, password) {
            const combinedArray = base64ToArrayBuffer(base64Data);
            const iv = new Uint8Array(combinedArray.slice(0, 12));
            const salt = new Uint8Array(combinedArray.slice(12, 28));
            const encryptedData = new Uint8Array(combinedArray.slice(28));
            const key = await generateKey(password, salt);
            const decrypted = await window.crypto.subtle.decrypt({ name: "AES-GCM", iv: iv }, key, encryptedData);
            return new TextDecoder().decode(decrypted);
        }

        document.getElementById('submit').addEventListener('click', async () => {
            const mode = document.getElementById('mode').value;
            const password = document.getElementById('password').value.trim();
            const text = document.getElementById('text').value.trim();
            const resultField = document.getElementById('result');

            if (!password || !text) {
                alert('Password and text fields must not be empty.');
                return;
            }

            if (mode === 'encrypt') {
                resultField.value = await encrypt(text, password);
            } else {
                try {
                    resultField.value = await decrypt(text, password);
                } catch (e) {
                    resultField.value = 'Decryption failed: ' + e.message;
                }
            }
        });

        function getCurrentDate() {
            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');
            return `${yyyy}${mm}${dd}`;
        }

        function getExportContent(result, password) {
            const include = document.getElementById('includePassword').checked;
            return include ? `${result}

password: ${password}` : result;
        }

        document.getElementById('copyButton').addEventListener('click', () => {
            const resultField = document.getElementById('result');
            const content = getExportContent(resultField.value, document.getElementById('password').value);
            navigator.clipboard.writeText(content).then(() => {
                const checkmark = document.querySelector('#copyButton .checkmark');
                checkmark.style.display = 'inline';
                setTimeout(() => checkmark.style.display = 'none', 2000);
            });
        });

        document.getElementById('downloadButton').addEventListener('click', () => {
            const resultField = document.getElementById('result');
            const content = getExportContent(resultField.value, document.getElementById('password').value);
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `v2xcrypt${getCurrentDate()}as.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            const checkmark = document.querySelector('#downloadButton .checkmark');
            checkmark.style.display = 'inline';
            setTimeout(() => checkmark.style.display = 'none', 2000);
        });

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js');
        }
    </script>
</body>
</html>
